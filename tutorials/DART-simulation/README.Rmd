# Summary 

This tutorial outlines the configuration of the DART model for creation of atmospheric emission and transmissivity of the air between surfaces and a camera, throught the perspective of a [model world](../Model-world) camera.

# DART model configuration

The DART simulation template can be found [here TO ADD](README_files/).

## Import 3D model

Import the 3D model into the DART simulation and put it in the middle of the DART scene.


## DART camera - location coordinates

For a model world camera with XYZ location

```
X[mw] = -28.553
Y[mw] = -27.9681
Z[mw] =  87.1
```

with the world coordinate origin in the center of the scene, the comparable DART camera coordinates are

```
X[dart] = (max(Y[dart]) / 2) + Y[mw]
Y[dart] = (max(X[dart]) / 2) + X[mw]
Z[dart] =  Z[mw]
```
becuase the DART world coordinate origin is in the "top left" and the X and Y axes are opposite to that of Blender. 

``` {r}
Xdart_max <- Ydart_max <- 300
Xmw <- -28.553
Ymw <- -27.9681
Xdart <- (Xdart_max / 2) + Ymw
Ydart <- (Ydart_max / 2) + Xmw
```

``` {r}
print(Xdart)
print(Ydart)
```

## DART camera - rotation vector

### Inside scene camera

The DART camera rotation can be directly translated from the Blender coordinates when using the "inside scene" camera. 

### Frame camera

When using a camera above the tallest model world surface, the "frame camera" should be used. With the Blender rotation order as XZY, set the DART frame camera rotation order to XZY. The Blender camera rotation vector (X[mw]... etc) is related to DART frame camera rotation by: 

```
X[dart] = X[mw]
Y[dart] = Z[mw]
Z[dart] = -Y[mw]
```

# Read DART data

```{r}
library(daRt)
library(dplyr)
library(ggplot2)
print( getwd())
simDir <- "README_files/DART-simulation/dart-atmos-corr"

sF_trans <- daRt::simulationFilter(product = "images", bands = integer(), iters = "ITERX", 
                                   imageTypes = c("camera_transmittance"), typeNums = "",
                                   variables = "Tapp")
sF_tapp <- sF_trans
imageTypes(sF_tapp) <- "camera"
typeNums(sF_tapp) <- "1_Fluid"

simData_transAtm <- daRt::getData(x = simDir, sF = sF_trans)
simData_tappAtm <- daRt::getData(x = simDir, sF = sF_tapp)

simData_radAtm <- tappToRadiance(simData_tappAtm)

transDF <- as.data.frame(simData_transAtm)
transDF$value[transDF$value == 0] <- NA
radDF <- as.data.frame(simData_radAtm)
radDF$value[radDF$value == 0] <- NA

```

Now plot the data.
``` {r}

plotThemes <- theme(
  axis.text = element_blank(),
  axis.title = element_blank(),
  axis.ticks = element_blank(), 
  panel.spacing = unit(0.1, "lines"),
  strip.text = element_text(size = 5, margin = margin(0, 0, 0, 0)),
  strip.background = element_rect(fill = "white", margin(0, 0, 0, 0)),
  aspect.ratio = 120 / 160
)

ggplot(transDF) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  facet_wrap(~ band, ncol = 7) +
  theme_bw() +
  plotThemes +
  coord_flip() +
  scale_x_reverse(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  ggtitle("Atmospheric spectral transmittance")

ggplot(radDF) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  facet_wrap(~ band, ncol = 7) +
  theme_bw() +
  plotThemes +
  coord_flip() +
  scale_x_reverse(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  ggtitle("Atmospheric spectral radiance")

```


```{r temp functions}

.planck <- function(lam, Temp){
  #lam is wavelenght in microns
  #Temp is temperature in Kelvin
  
  #boltzmann constant m^2 kg s^-2 K^-1
  k <- 1.38064852e-23
  #planck constant m^2 kg s^-1
  h <- 6.62607004e-34
  #speed of light m s^-1
  cc <- 299792458
  
  
  lam <- lam * 1e-6
  specRad <- (((2 * h) * (cc^2))/((lam^5) * (exp((h * cc) / (lam * k * Temp)) - 1))) * 1e-6
  
  return(specRad)
  
}

SRFinterp <- function(SRF_raw, simData, sigFig = 4) {
  
  require(dplyr)
  require(imputeTS)
  
  #todo - normalise
  #todo - check within min and max
  
  lambdaCols <- c("lambdamin", "lambdamid", "lambdamax", "equivalentWavelength")
  wavelengthVals <- wavelengths(simData)
  wavelengthVals[, lambdaCols] <- round(wavelengthVals[, lambdaCols], sigFig)
  SRF_raw_edited <- SRF_raw %>%
    dplyr::mutate(lambda = round(lambda, sigFig)) %>%
    dplyr::filter(!duplicated(lambda))
  minMaxPer <- sapply(wavelengthVals[, lambdaCols], function(x) 
    c(min(x, na.rm = TRUE), max(x, na.rm = TRUE)))
  minMaxAll <- apply(minMaxPer, 1, function(x) 
    c(min(x, na.rm = TRUE), max(x, na.rm = TRUE)))
  lambdaOUTall <- seq(minMaxAll[, 1][1], minMaxAll[, 2][2], by = 1 * 10^-(sigFig))
  dfOUT <- data.frame(lambda = lambdaOUTall) %>%
    dplyr::mutate(lambda = round(lambda, sigFig)) %>%
    dplyr::filter(!duplicated(lambda))
  lambdaDF <- dfOUT %>% 
    dplyr::left_join(SRF_raw_edited, by = "lambda") %>%
    dplyr::mutate(value = imputeTS::na_interpolation(value))
  wavelengthOut <- wavelengthVals
  for (lambdaCol in lambdaCols) {
    lambdaDFout <- lambdaDF
    colnames(lambdaDFout) <- c(lambdaCol, paste0(lambdaCol, "_SRF"))
    wavelengthOut <- wavelengthOut %>%
      dplyr::left_join(lambdaDFout, by = lambdaCol)
  }
  wavelengthOutDF <- dplyr::bind_cols(wavelengthOut)
  
  return(wavelengthOutDF)
}

```


```{r}
thermographToSpectralRadiance <- function(thermograph, simData) {
  
  require(dplyr)
  
  wavelengthVals <- wavelengths(simData)
  
  wavelengthDF <- expand.grid(
    x = unique(thermograph$x), 
    y = unique(thermograph$y),
    band = unique(wavelengthVals$band)) %>%
    dplyr::left_join(wavelengthVals, by = "band")
  
  spectralRadDF <- wavelengthDF %>%
    dplyr::left_join(thermograph, by = c("x", "y")) %>%
    dplyr::mutate(value = .planck(lam = equivalentWavelength, Temp = value))
  
  return(spectralRadDF)
}
```


``` {r}
bandRadiance_surf <- function(LCam_spectralBrick, simData_transAtm, simData_radAtm, SRF_raw) {
  
  SRF <- SRFinterp(SRF_raw, simData_transAtm)
  
  Lcam_attenuated <- LCam_spectralBrick %>% 
    dplyr::left_join(as.data.frame(simData_transAtm) %>% 
                       dplyr::mutate(tau = value) %>%
                       dplyr::select(-value), 
                     by = c("x", "y", "band", "simName")) %>%
    dplyr::mutate(value = value / tau) %>%
    dplyr::select(-tau)
  
  Latm_attenuated <- as.data.frame(simData_radAtm) %>% 
    dplyr::left_join(SRF %>% 
                       dplyr::select(-c(
                         lambdamin_SRF, 
                         lambdamid_SRF, 
                         lambdamax_SRF, 
                         equivalentWavelength_SRF)), 
                     by = c("band", "simName")) %>%
    dplyr::left_join(as.data.frame(simData_transAtm) %>% 
                       dplyr::mutate(tau = value) %>%
                       dplyr::select(-value), 
                     by = c("x", "y", "band", "variable", "iter", "typeNum", 
                            "imgType", "imageNo", "VZ", "VA", "simName", "transmittance")) %>%
    dplyr::mutate(value = value / tau) %>%
    dplyr::select(-tau)
  
  Lcam_bandRad <- getBandRadiance(spectralDF = Lcam_attenuated, 
                                  SRF = SRF)
  Latm_bandRad <- getBandRadiance(spectralDF = Latm_attenuated, 
                                  SRF = SRF)
  
  OUTdf <- Lcam_bandRad %>%
    dplyr::left_join(
      Latm_bandRad %>%
        dplyr::mutate(bandValue_Latm = bandValue) %>%
        dplyr::select(-bandValue),
      by = c("x", "y", "iter", "imgType", "imageNo", "VZ", "VA")) %>%
    dplyr::mutate(bandValue = bandValue - bandValue_Latm)
  
  return(OUTdf)
}


getBandRadiance <- function(spectralDF, SRF) {
  
  SRFbandvals <- SRF %>% 
    dplyr::select(-c(lambdamin, lambdamid, lambdamax, equivalentWavelength))
  
  spectralDFintegrals <- spectralDF %>%
    dplyr::left_join(SRFbandvals, 
                     by = c("band", "simName")) %>%
    dplyr::mutate(deltaLambda = lambdamax - lambdamin,
                  LHS = value * lambdamin_SRF + value * lambdamid_SRF,
                  RHS = value * lambdamid_SRF + value * lambdamax_SRF,
                  integral = (LHS + RHS) * deltaLambda * 0.5) %>%
    dplyr::group_by(x, y, iter, imgType, imageNo, VZ, VA) %>%
    dplyr::summarise(bandValue = sum(integral, na.rm = TRUE))
  
  return(spectralDFintegrals)
}

```

```{r}
DFobs <- expand.grid(x = unique(transDF$x), y = unique(transDF$y), value = 300)

SRF_raw <- data.frame("lambda" = seq(5, 20, by = 1e-5), "value" = seq(1, 1, length.out = length(seq(5, 20, by = 1e-5))))

LcamSpectral <- thermographToSpectralRadiance(thermograph = DFobs, simData = simData_radAtm)

bandRadDF <- bandRadiance_surf(LCam_spectralBrick = LcamSpectral, simData_transAtm = simData_transAtm, simData_radAtm = simData_radAtm, SRF_raw = SRF_raw)


ggplot(bandRadDF %>% filter(between(bandValue, 130, 150))) +
  geom_raster(aes(x = x, y = y, fill = bandValue)) +
  theme_bw() +
  coord_flip() +
  scale_x_reverse() +
  ggtitle("Surface-leaving band radiance")


```